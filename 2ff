#!/bin/sh
if [ "$#" -ne 0 ]; then
	echo "usage: $0" >&2
	exit 1
fi

TMP=$(mktemp)
trap 'rm "$TMP"' EXIT

cat > "$TMP"

if [ "$(dd if="$TMP" bs=1 count=8 2>/dev/null)" = "farbfeld" ]; then
	cat "$TMP"
	exit 0
fi

FORMAT=$(file -ib "$TMP" | cut -d ";" -f 1)

case "$FORMAT" in
image/png)
	png2ff < "$TMP"
	;;
image/jpeg)
	jpg2ff < "$TMP"
	;;
*)
	if [ ! -x /usr/bin/convert ] ; then
		printf "%s: cant convert from %s -- missing \`convert' program" "$0" "$FORMAT" >&2
		printf "Run \`apt-get install imagemagick' to install it" >&2
		exit 1
	fi
	convert "$TMP" png:- 2>/dev/null | png2ff 2>/dev/null
	;;
esac

if [ $? -ne 0 ]; then
	printf "%s: failed to convert from %s\n" "$0" "$FORMAT" >&2
	exit 1
fi

exit 0
